From: Liliana Marie Prikler <liliana.prikler@gmail.com>
Date: Sat, 19 Aug 2023 08:38:17 +0200
Subject: [PATCH] Guard against empty snippet in yas-next-field.

diff --git a/yasnippet.el b/yasnippet.el
index 26ad47f..f6955eb 100644
--- a/yasnippet.el
+++ b/yasnippet.el
@@ -135,6 +135,7 @@
 (require 'eldoc) ; Needed for Emacs<25.
 (require 'easymenu)
 (require 'help-mode)
+(require 'subr-x)
 
 (defvar yas--editing-template)
 (defvar yas--guessed-modes)
@@ -3389,20 +3390,20 @@ Otherwise delegate to `yas-next-field'."
 If there's none, exit the snippet."
   (interactive)
   (unless arg (setq arg 1))
-  (let* ((active-field (overlay-get yas--active-field-overlay 'yas--field))
-         (snippet (car (yas-active-snippets (yas--field-start active-field)
-                                            (yas--field-end active-field))))
-         (target-field (yas--find-next-field arg snippet active-field)))
-    (yas--letenv (yas--snippet-expand-env snippet)
-      ;; Apply transform to active field.
-      (when active-field
-        (let ((yas-moving-away-p t))
-          (when (yas--field-update-display active-field)
-            (yas--update-mirrors snippet))))
-      ;; Now actually move...
-      (if target-field
-          (yas--move-to-field snippet target-field)
-        (yas-exit-snippet snippet)))))
+  (and-let* ((active-field (overlay-get yas--active-field-overlay 'yas--field))
+             (snippet (car (yas-active-snippets (yas--field-start active-field)
+                                                (yas--field-end active-field)))))
+    (let ((target-field (yas--find-next-field arg snippet active-field)))
+      (yas--letenv (yas--snippet-expand-env snippet)
+        ;; Apply transform to active field.
+        (when active-field
+          (let ((yas-moving-away-p t))
+            (when (yas--field-update-display active-field)
+              (yas--update-mirrors snippet))))
+        ;; Now actually move...
+        (if target-field
+            (yas--move-to-field snippet target-field)
+          (yas-exit-snippet snippet))))))
 
 (defun yas--place-overlays (snippet field)
   "Correctly place overlays for SNIPPET's FIELD."
